// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


//Model User
model User {
  id Int @id @default(autoincrement())
  email String? @unique
  firstname String? 
  lastname String?
  password String?
  avatarUrl String?
  twoFactorEnable Boolean @default(false)
  twoFactorSecret String?
  isVerified Boolean @default(false)
  createdAt DateTime @default(now())
  updateAt DateTime @updatedAt

  //relation
  sessions Session[]
  oauths OAuth[]
  otpModels OtpModel[]

  workSpaces WorkSpace[] @relation("WorkSpaceOwner")

  workSpaceMembers WorkSpaceMembers[]

  userPreferences UserPreference[]
}


//Model Session
model Session{
  id Int  @id @default(autoincrement())
  userId Int
  refreshToken String @unique
  userAgent String?
  ipAddress String?
  location String?
  expirates DateTime 
  createdAt DateTime @default(now())

  //relation
  user  User @relation( fields: [userId], references: [id], onDelete: Cascade)

}

//Model OAutModel
model OAuth{
  id Int @id @default(autoincrement())
  userId Int
  type String
  provider String
  providerAccountId String

  //relation
  user  User @relation( fields: [userId], references: [id], onDelete: Cascade)
   @@unique([provider, providerAccountId])
}

//Otp Model
model OtpModel{
  id Int @id @default(autoincrement())
  email String @unique
  code String @unique
  expirateAt DateTime
  createdAt DateTime @default(now())

  //relation
  user User @relation(fields: [email], references: [email], onDelete: Cascade)
}

model UserPreference {
  id             Int     @id @default(autoincrement())
  userId         Int     @unique
  theme          String  @default("system") // "light", "dark", "system"
  language       String  @default("fr")
  notifications  String  @default("all") // JSON string pour préférences détaillées
  
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}



//Model pour un espace de travail
model WorkSpace{
  id Int @id @default(autoincrement())
  name String 
  slug String @unique
  logoUrl String?
  ownerId Int
  createdAt DateTime @default(now())
  owner User @relation("WorkSpaceOwner", fields: [ownerId], references: [id])

  workSpaceMembers WorkSpaceMembers[]

  invitations Invitation[]

  auditLogs AuditLog[]

  projects Project[]
}

//Model pour les membres d'un WorkSpace
model WorkSpaceMembers{
  id Int @id @default(autoincrement())
  role String @default("MEMBER") //OWNER, MEMBER, GUEST, ADMIN
  userId Int
  workSpaceId Int
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade )
  workspace WorkSpace @relation(fields: [workSpaceId], references: [id], onDelete: Cascade )

  @@unique([userId, workSpaceId])
}

model Invitation {
  id          Int       @id @default(autoincrement())
  email       String
  token       String    @unique
  role        String    @default("MEMBER")
  workspaceId Int
  invitedById Int
  expiresAt   DateTime
  status      String    @default("PENDING") 
  workspace   WorkSpace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id          Int       @id @default(autoincrement())
  workspaceId Int
  userId      Int
  action      String    // ex: "MEMBER_REMOVED", "SETTINGS_CHANGED"
  entity      String    
  entityId    Int?
  details     String?   // JSON string des changements
  createdAt   DateTime  @default(now())
  workspace   WorkSpace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Project{
  id Int @id @default(autoincrement())
  name String 
  description String?
  isTemplate Boolean @default(false)
  workspaceId Int
  deletedAt  DateTime?
  
  projectShares ProjectShare[]
  projectTags ProjectTag[]
  sprints Sprint[]
  tasks Task[]
  workspace   WorkSpace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model ProjectShare{
  id Int @id @default(autoincrement())
  projectId Int @unique
  token String @unique
  isEnable Boolean @default(true)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ProjectTag {
  id        Int      @id @default(autoincrement())
  name      String
  color     String   @default("#0f1b85ff")
  projectId Int
  
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Sprint{
  id Int @id @default(autoincrement())
  name String 
  startDate DateTime
  endDate   DateTime
  status String @default("PLANNED")
  projectId Int

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  tasks Task[]
}

model Task{
  id Int @id @default(autoincrement())
  title String
  description String?
  type String
  projectId Int
  sprintId Int?
  priority String @default("MEDIUM")
  status String @default("TODO")
  startDate DateTime?
  endDate DateTime?
  estimatedTime Int?

  project Project @relation(fields: [projectId], references: [id])
  sprint Sprint? @relation(fields: [sprintId], references: [id])
}
